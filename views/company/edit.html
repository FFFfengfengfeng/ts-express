<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../css/bootstrap.css">
    <link rel="stylesheet" href="../../css/main.css">
    <title>编辑公司</title>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="list-group">
            <a href="../company/"    class="list-group-item active">公司管理</a>
            <a href="../employee/"   class="list-group-item">人员管理</a>
            <a href="../place/"      class="list-group-item">地点管理</a>
            <a href="../type/"       class="list-group-item">保险管理</a>
            <a href="../contract/"   class="list-group-item">合同管理</a>
            <a href="../compensate/" class="list-group-item">理赔管理</a>
            <a href="../customer/"   class="list-group-item">对象管理</a>
            <a href="../compete/"    class="list-group-item">竞争分析</a>
            <a href="../release/"    class="list-group-item">网销发布</a>
            <a href="../down/"       class="list-group-item">网销下载</a>
            <a href="../backstage"   class="list-group-item">后台管理</a>
        </div>
    </div>
    <div class="main-content">
        <div class="panel panel-default">
            <div class="panel-heading">编辑公司</div>
            <div class="panel-body">
                <form action="" class="form-horizontal">
                    <div class="form-group">
                        <label for="inputName" class="control-label col-sm-3">公司名:</label>
                        <div class="col-sm-3">
                            <input type="email" class="form-control" id="inputName" placeholder="名称">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="" class="control-label col-sm-3">公司种类:</label>
                        <div class="col-sm-3">
                            <select class="form-control" id="selType">
                                <option value="-1">请选择</option>
                                <option value="1">财产保险</option>
                                <option value="2">人身保险</option>
                                <option value="3">责任保险</option>
                                <option value="4">信用保险</option>
                                <option value="5">保证保险</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="" class="control-label col-sm-3">地区:</label>
                        <div class="col-sm-3">
                            <select class="form-control" id="selPlace"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="" class="control-label col-sm-3">上传logo:</label>
                        <div class="col-sm-9">
                            <a href="javascript:;" class="btn btn-warning btn-upload" id="btnUpload">
                                <span class="glyphicon glyphicon-download-alt"></span> 点击上传
                            </a>
                            <span class="text-danger">请上传200x200的图片</span>
                            <div class="preview-box">
                                <img class="preview-img" src="" alt="">
                            </div>
                            <p class="btn-upload-txt text-danger"></p>
                        </div>
                    </div>
                    <div class="col-sm-9 col-sm-offset-3">
                        <!--<div class="form-group"></div>-->
                        <a href="javascript:;" class="btn btn-success" id="btnSave">保存</a>
                        <span class="text-danger hide" id="formAlert"></span>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/tmpl.min.js"></script>
    <script src="../../js/bootstrap.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/plupload.full.min.js"></script>
    <script>
        (function () {

            var uploader = new plupload.Uploader({
                runtimes: 'html5,html4,flash',
                browse_button : 'btnUpload', //触发文件选择对话框的按钮，为那个元素id
                url : '../../Api/Upload/Image.php', //服务器端的上传页面地址
                multi_selection: false,
                filters: {
                    max_file_size: '5mb',
                    mine_types: [
                        {title: 'Image files', extensions: 'jpg,png,jpeg,gif'}
                    ],
                    min_img_resolution : [594, 350]
                },
                init: {
                    FilesAdded: function(uploader, files) {
                        uploader.disableBrowse(true);
                        uploader.start();
                    },
                    UploadProgress: function(uploader, file) {
                        $('.btn-upload-txt').html('上传中：' + file.percent +'%');
                    },
                    FileUploaded: function(uploader, file, response) {
                        uploader.disableBrowse(false);
                        var data = JSON.parse(response.response),
                            src = data.src;
                        $('.preview-box img').attr('src', src);
                        $('.btn-upload-txt').html('上传成功');
                    },
                    Error: function(uploader, err) {
                        uploader.disableBrowse(false);

                        $('.btn-upload-txt').html('上传失败');
                    }
                }
            });
            uploader.init();
            function getItem(id) {
                $.ajax({
                    url: '../../Api/Company/Item.php',
                    data: {
                        id: id
                    },
                    dataType: 'json',
                    method: 'POST',
                    success: function (res) {
                        $('#inputName').val(res.data[0].name);
                        $('#selType').val(res.data[0].type);
                        $('#selPlace').val(res.data[0].place);
                        $('.preview-img').attr('src', res.data[0].logo);
                    }
                });
            }
            function getPlace() {
                $.ajax({
                    url: '../../Api/Place/List.php',
                    data: {},
                    dataType: 'json',
                    method: 'POST',
                    success: function (res) {
                        var data = res.data,
                            str = '<option value="-1">请选择</option>\n';
                        if (data.length > 0) {
                            for (var i = 0; i < data.length; i ++) {
                                str +=  '<option value="' + data[i].id + '">' + data[i].name + '</option>\n';
                            }
                        }
                        $('#selPlace').html(str);
                    }
                });
            }
            getPlace();
            getItem($.queryString('id'));
            $('#btnSave').on('click', function (e) {
                var selPlace  = $('#selPlace').val(),
                    selType   = $('#selType').val(),
                    inputName = $('#inputName').val(),
                    formAlert = $('#formAlert'),
                    logo      = $('.preview-img').attr('src');
                if (selPlace === '-1' || selType === '-1' || inputName === '') {
                    formAlert.removeClass('hide');
                    formAlert.fadeIn();
                }
                if (inputName === '') {
                    formAlert.html('请输入公司名字');
                } else if (selType === '-1') {
                    formAlert.html('请选择类型');
                } else if (selPlace === '-1') {
                    formAlert.html('请选择地区');
                } else {
                    formAlert.addClass('hide');
                    $.ajax({
                        url: '../../Api/Company/Edit.php',
                        data: {
                            name : inputName,
                            logo : logo,
                            place: selPlace,
                            type : selType
                        },
                        method: 'POST',
                        dataType: 'json',
                        success: function (res) {
//
                        }
                    });
                }
            })
        })();
    </script>

</body>
</html>